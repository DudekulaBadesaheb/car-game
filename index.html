<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Full 3D Car Game — Mobile & Desktop</title>
<style>
html, body { height:100%; margin:0; overflow:hidden; background:#062122; color:#fff; font-family:Inter, system-ui, Segoe UI, Roboto, Arial; }
#gameContainer { position:fixed; left:0; top:0; right:0; bottom:0; display:block; }
canvas { display:block; }

/* HUD */
#hud { position: fixed; left:12px; top:12px; z-index:60; background:rgba(0,0,0,0.25); padding:10px 12px; border-radius:10px; font-size:14px; }
#minimapWrapper { position:fixed; right:12px; top:12px; z-index:50; width:260px; height:160px; border-radius:10px; overflow:hidden; background:linear-gradient(180deg,#05171b,#021016); }
#minimap { width:100%; height:100%; display:block; }

/* Shop Overlay */
#shopOverlay { position: fixed; left:50%; top:50%; transform:translate(-50%, -50%); width:920px; max-width:96%; height:540px; max-height:92%; background:linear-gradient(180deg,rgba(6,12,18,0.98),rgba(3,6,10,0.98)); border-radius:14px; z-index:100; display:none; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,0.7); }
.car-card { display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.02); margin-bottom:10px; }
.btn { padding:8px 14px; border-radius:10px; background:#0d6efd; color:#fff; border:none; cursor:pointer; }

/* Mobile Controls */
.control-pad { position:fixed; right:12px; bottom:12px; z-index:80; display:flex; flex-direction:column; gap:8px; }
.control-row { display:flex; gap:8px; }
.ctl-btn { width:64px; height:64px; border-radius:10px; background:rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 16px rgba(0,0,0,0.5); cursor:pointer; user-select:none; }
.ctl-btn:active { transform:translateY(2px); }
.brake { background: linear-gradient(180deg,#6b0b0b,#3c0202); }

/* Login */
#loginModal { position: fixed; left:50%; top:50%; transform:translate(-50%, -50%); z-index:300; background:linear-gradient(180deg,#05141a,#021014); padding:18px; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,0.7); width:360px; }
#loginModal input { width:100%; padding:8px; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff; }

/* Level Complete Overlay */
#levelCompleteOverlay { position: fixed; left:50%; top:50%; transform:translate(-50%, -50%); z-index:200; background:linear-gradient(180deg,rgba(2,8,10,0.98),rgba(8,14,18,0.98)); padding:20px; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,0.7); display:none; min-width:360px; text-align:center; }
#levelCompleteOverlay h2 { margin:0 0 8px 0; }
#levelCompleteOverlay .actions { display:flex; gap:10px; justify-content:center; margin-top:12px; }

/* Footer */
#footerHints { position:fixed; left:12px; bottom:12px; z-index:40; font-size:13px; color:#cfe; }
</style>
</head>
<body>
<div id="gameContainer"></div>

<div id="hud">
<div>User: <span id="userName">Guest</span></div>
<div>Level: <span id="levelLabel">1</span> / <span id="totalLevels">1000</span></div>
<div>Coins: <span id="coinsLabel">0</span></div>
<div>Time: <span id="timeLabel">0.00</span>s</div>
</div>

<div id="minimapWrapper"><canvas id="minimap"></canvas></div>

<!-- Login Modal -->
<div id="loginModal" style="display:none">
<h3>Sign in</h3>
<div class="muted">Enter your name and mobile number. You'll be remembered on this device.</div>
<input id="loginName" placeholder="Full name" />
<input id="loginMobile" placeholder="Mobile number (ID)" />
<button id="loginBtn" class="btn" style="margin-top:10px;width:100%">Sign in & Save</button>
<div style="margin-top:8px;font-size:12px;opacity:0.8">Your data is stored locally and optionally sent to your Google Sheet when enabled.</div>
</div>

<!-- Shop Overlay -->
<div id="shopOverlay" aria-hidden="true">
<button id="closeShop" class="btn" style="position:absolute; right:14px; top:12px">Close</button>
<h2>Garage — Buy / Select Cars</h2>
<div style="display:flex; gap:12px; height:100%; align-items:flex-start">
<div style="flex:1; overflow:auto; padding-right:8px"><div id="carsList"></div></div>
<div style="width:260px">
<div style="background:rgba(255,255,255,0.02); padding:12px; border-radius:8px">
<h4>Your Coins</h4>
<div style="font-size:20px" id="shopCoins">0</div>
<hr style="opacity:0.08; border-color:#fff" />
<div><strong>Selected:</strong> <span id="shopSelected">None</span></div>
<div style="height:12px"></div>
<button id="buyBtn" class="btn" style="width:100%">Buy / Select</button>
</div></div></div></div>

<!-- Level Complete -->
<div id="levelCompleteOverlay">
<h2 id="completeTitle">Level Complete</h2>
<p id="completeMsg">You finished level <span id="completeLevel">1</span>!</p>
<div class="muted">Total coins: <span id="completeCoins">0</span></div>
<div class="actions">
<button id="nextLevelBtn" class="btn">Next Level</button>
<button id="skipTo3Btn" class="btn">Go to Level 3</button>
<button id="closeOverlayBtn" class="btn">Close</button>
</div>
</div>

<!-- Controls -->
<div class="control-pad" id="controls">
<div class="control-row">
<div class="ctl-btn" id="btnLeft">◄</div>
<div class="ctl-btn" id="btnForward">▲</div>
<div class="ctl-btn" id="btnRight">►</div>
</div>
<div class="control-row">
<div class="ctl-btn brake" id="btnBrake">Brake</div>
<div class="ctl-btn" id="btnBoost">Boost</div>
<div class="ctl-btn" id="btnShop">Shop</div>
</div>
</div>

<div id="footerHints">Controls: W/A/S/D or ←→↑↓ • On-screen buttons • Shift=Boost • R=Restart • N=Next • M=Toggle minimap • S=Shop</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
// --- Configuration ---
const TOTAL_LEVELS = 1000;
const API_URL = null; // Google Sheets Apps Script URL (optional)

// --- Persistent Storage ---
function userKey(mobile){return `game_user_${mobile}`;}
let currentUser=null;
function loadUser(){try{const saved=localStorage.getItem("last_logged_user");if(!saved)return null; const data=JSON.parse(localStorage.getItem(userKey(saved))); return data||null;}catch(e){return null;}}
function saveUser(u){if(!u||!u.mobile)return; localStorage.setItem(userKey(u.mobile),JSON.stringify(u)); localStorage.setItem("last_logged_user",u.mobile); if(API_URL) sendToServer(u);}
function sendToServer(u){fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(console.warn);}

// --- Game State ---
let coins=0, level=1, carSelected=null, ownedCars=["Standard Car"], startTime=null;

// --- Login Handling ---
const loginModal=document.getElementById("loginModal");
function showLogin(){loginModal.style.display="block";}
function hideLogin(){loginModal.style.display="none";}
document.getElementById("loginBtn").onclick=function(){
 const name=document.getElementById("loginName").value.trim();
 const mobile=document.getElementById("loginMobile").value.trim();
 if(!name||!mobile){alert("Enter name & mobile");return;}
 currentUser={name:name,mobile:mobile,coins:coins,ownedCars:ownedCars,selectedCar:carSelected||"Standard Car"};
 saveUser(currentUser);
 updateHUD();
 hideLogin();
};
let storedUser=loadUser();
if(storedUser){currentUser=storedUser; coins=currentUser.coins||0; level=storedUser.level||1; carSelected=currentUser.selectedCar||"Standard Car"; ownedCars=currentUser.ownedCars||["Standard Car"];} 
else{showLogin();}

// --- HUD ---
const userNameLabel=document.getElementById("userName");
const levelLabel=document.getElementById("levelLabel");
const totalLevelsLabel=document.getElementById("totalLevels");
const coinsLabel=document.getElementById("coinsLabel");
function updateHUD(){userNameLabel.textContent=currentUser?.name||"Guest"; levelLabel.textContent=level; totalLevelsLabel.textContent=TOTAL_LEVELS; coinsLabel.textContent=coins;}
updateHUD();

// --- Shop System ---
const shopOverlay=document.getElementById("shopOverlay");
const carsListDiv=document.getElementById("carsList");
const shopCoinsLabel=document.getElementById("shopCoins");
const shopSelectedLabel=document.getElementById("shopSelected");
const buyBtn=document.getElementById("buyBtn");
const closeShopBtn=document.getElementById("closeShop");
const shopCars=[
 {name:"Standard Car",price:0},
 {name:"Red Racer",price:500},
 {name:"Blue Bullet",price:700},
 {name:"Speedster",price:1000},
 {name:"Gold Chariot",price:5000}
];
function openShop(){shopOverlay.style.display="block"; refreshShop();}
function closeShop(){shopOverlay.style.display="none";}
closeShopBtn.onclick=closeShop;
document.getElementById("btnShop").onclick=openShop;
function refreshShop(){
 shopCoinsLabel.textContent=coins;
 carsListDiv.innerHTML="";
 shopCars.forEach(c=>{
   const div=document.createElement("div");
   div.className="car-card";
   div.textContent=`${c.name} — ${c.price} coins`;
   if(ownedCars.includes(c.name)) div.style.background="rgba(0,128,64,0.15)";
   div.onclick=()=>{carSelected=c.name; shopSelectedLabel.textContent=c.name;};
   carsListDiv.appendChild(div);
 });
 shopSelectedLabel.textContent=carSelected||"None";
}
buyBtn.onclick=function(){
 if(!carSelected) return alert("Select a car!");
 const car=shopCars.find(c=>c.name===carSelected);
 if(!car) return;
 if(ownedCars.includes(car.name)){ alert(`Selected ${car.name}`); } 
 else if(coins>=car.price){ coins-=car.price; ownedCars.push(car.name); currentUser.coins=coins; currentUser.ownedCars=ownedCars; currentUser.selectedCar=car.name; saveUser(currentUser); alert(`Purchased ${car.name}`); refreshShop(); updateHUD(); } 
 else{ alert("Not enough coins!"); }
};

// --- Level Complete Overlay ---
const levelCompleteOverlay=document.getElementById("levelCompleteOverlay");
document.getElementById("nextLevelBtn").onclick=function(){level++; hideLevelComplete(); updateHUD();}
document.getElementById("skipTo3Btn").onclick=function(){level=3; hideLevelComplete(); updateHUD();}
document.getElementById("closeOverlayBtn").onclick=hideLevelComplete;
function showLevelComplete(){levelCompleteOverlay.style.display="block";}
function hideLevelComplete(){levelCompleteOverlay.style.display="none";}

// --- Controls ---
let keys={ArrowLeft:false,ArrowRight:false,ArrowUp:false,ArrowDown:false,KeyW:false,KeyA:false,KeyS:false,KeyD:false,ShiftLeft:false};
window.addEventListener("keydown",e=>{keys[e.code]=true;});
window.addEventListener("keyup",e=>{keys[e.code]=false;});

// --- Mobile Buttons ---
["btnLeft","btnRight","btnForward","btnBrake","btnBoost"].forEach(id=>{
 const el=document.getElementById(id);
 el.addEventListener("touchstart",e=>{keys[id.replace("btn","Arrow")]=true; e.preventDefault();});
 el.addEventListener("touchend",e=>{keys[id.replace("btn","Arrow")]=false; e.preventDefault();});
});

// --- Three.js Scene ---
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x062122);
const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,2000);
camera.position.set(0,6,12);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.getElementById("gameContainer").appendChild(renderer.domElement);

// --- Lighting ---
const light=new THREE.DirectionalLight(0xffffff,1); light.position.set(0,10,10); scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.4));

// --- Car ---
const carGeometry=new THREE.BoxGeometry(2,1,4);
const carMaterial=new THREE.MeshStandardMaterial({color:0xff3333});
const car=new THREE.Mesh(carGeometry,carMaterial);
scene.add(car);
car.position.y=0.5;

// --- Ground ---
const groundGeometry=new THREE.PlaneGeometry(2000,2000);
const groundMaterial=new THREE.MeshStandardMaterial({color:0x111111});
const ground=new THREE.Mesh(groundGeometry,groundMaterial);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

// --- Simple Game Loop ---
let lastTime=performance.now();
function animate(){
 const now=performance.now();
 const delta=(now-lastTime)/1000;
 lastTime=now;

 // Car movement
 const speed= keys.ShiftLeft?25:15;
 if(keys.ArrowUp||keys.KeyW) car.position.z-=speed*delta;
 if(keys.ArrowDown||keys.KeyS) car.position.z+=speed*delta;
 if(keys.ArrowLeft||keys.KeyA) car.position.x-=speed*delta*0.6;
 if(keys.ArrowRight||keys.KeyD) car.position.x+=speed*delta*0.6;

 camera.position.x=car.position.x; camera.position.z=car.position.z+12; camera.lookAt(car.position);

 renderer.render(scene,camera);
 requestAnimationFrame(animate);
}
animate();
window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);});
</script>
</body>
</html>
