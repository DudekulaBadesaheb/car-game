<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Full 3D Car Game — Persistent Users, 1000 Levels, Google Sheets Save</title>
<style>
html, body {height:100%; margin:0; overflow:hidden; background:#062122; color:#fff; font-family:Inter, system-ui, Segoe UI, Roboto, Arial;}
#gameContainer {position:fixed; left:0; top:0; right:0; bottom:0; display:block;}
canvas {display:block;}
#hud {position:fixed; left:12px; top:12px; z-index:60; background:linear-gradient(180deg, rgba(0,0,0,0.28), rgba(0,0,0,0.12)); padding:10px 12px; border-radius:10px; backdrop-filter:blur(6px); font-size:14px;}
#minimapWrapper {position:fixed; right:12px; top:12px; z-index:50; width:260px; height:160px; border-radius:10px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.6); background:linear-gradient(180deg,#05171b,#021016);}
#minimap {width:100%; height:100%; display:block;}
#shopOverlay {position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:920px; max-width:96%; height:540px; max-height:92%; background:linear-gradient(180deg,rgba(6,12,18,0.98),rgba(3,6,10,0.98)); border-radius:14px; z-index:100; display:none; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,0.7);}
.car-card {display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.02); margin-bottom:10px;}
.btn {padding:8px 14px; border-radius:10px; background:#0d6efd; color:#fff; border:none; cursor:pointer;}
#footerHints {position:fixed; left:12px; bottom:12px; z-index:40; font-size:13px; color:#cfe;}
.control-pad {position:fixed; right:12px; bottom:12px; z-index:80; display:flex; flex-direction:column; gap:8px;}
.control-row {display:flex; gap:8px;}
.ctl-btn {width:64px; height:64px; border-radius:10px; background:rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 16px rgba(0,0,0,0.5); cursor:pointer; user-select:none;}
.ctl-btn:active {transform:translateY(2px);}
.brake {background:linear-gradient(180deg,#6b0b0b,#3c0202);}
#loginModal {position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:300; background:linear-gradient(180deg,#05141a,#021014); padding:18px; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,0.7); width:360px;}
#loginModal input {width:100%; padding:8px; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff;}
#fullMapOverlay {position:fixed; left:0; top:0; right:0; bottom:0; z-index:500; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center;}
#fullMap {width:88%; height:88%; border-radius:12px; background:#041018;}
#levelCompleteOverlay {position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:200; background:linear-gradient(180deg,rgba(2,8,10,0.98),rgba(8,14,18,0.98)); padding:20px; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,0.7); display:none; min-width:360px; text-align:center;}
#levelCompleteOverlay h2 {margin:0 0 8px 0;}
#levelCompleteOverlay p {opacity:0.9;}
#levelCompleteOverlay .actions {display:flex; gap:10px; justify-content:center; margin-top:12px;}
</style>
</head>
<body>
<div id="gameContainer"></div>
<div id="hud">
  <div>User: <span id="userName">Guest</span></div>
  <div>Level: <span id="levelLabel">1</span> / <span id="totalLevels">1000</span></div>
  <div>Coins: <span id="coinsLabel">0</span></div>
  <div>Time: <span id="timeLabel">0.00</span>s</div>
</div>
<div id="minimapWrapper"><canvas id="minimap"></canvas></div>

<!-- Login modal -->
<div id="loginModal">
  <h3>Sign in</h3>
  <div class="muted">Enter your name and mobile number. You'll be remembered on this device.</div>
  <input id="loginName" placeholder="Full name" />
  <input id="loginMobile" placeholder="Mobile number (ID)" />
  <button id="loginBtn" class="btn" style="margin-top:10px;width:100%">Sign in & Save</button>
  <div style="margin-top:8px; font-size:12px; opacity:0.8">
    Your data is stored locally and optionally sent to your Google Sheet when you enable it in settings.
  </div>
</div>

<!-- Shop overlay -->
<div id="shopOverlay" aria-hidden="true">
  <button id="closeShop" class="btn" style="position:absolute;right:14px;top:12px">Close</button>
  <h2>Garage — Buy / Select Cars</h2>
  <div style="display:flex; gap:12px; height:100%; align-items:flex-start">
    <div style="flex:1; overflow:auto; padding-right:8px"><div id="carsList"></div></div>
    <div style="width:260px">
      <div style="background:rgba(255,255,255,0.02); padding:12px; border-radius:8px;">
        <h4>Your Coins</h4>
        <div style="font-size:20px" id="shopCoins">0</div>
        <hr style="opacity:0.08; border-color:#fff"/>
        <div><strong>Selected:</strong> <span id="shopSelected">None</span></div>
        <div style="height:12px"></div>
        <button id="buyBtn" class="btn" style="width:100%">Buy / Select</button>
      </div>
    </div>
  </div>
</div>

<!-- Full map overlay -->
<div id="fullMapOverlay"><div id="fullMap"></div></div>

<!-- Level complete overlay -->
<div id="levelCompleteOverlay">
  <h2 id="completeTitle">Level Complete</h2>
  <p id="completeMsg">You finished level <span id="completeLevel">1</span>!</p>
  <div class="muted">Total coins: <span id="completeCoins">0</span></div>
  <div class="actions">
    <button id="nextLevelBtn" class="btn">Next Level</button>
    <button id="skipTo3Btn" class="btn">Go to Level 3</button>
    <button id="closeOverlayBtn" class="btn">Close</button>
  </div>
</div>

<!-- Controls -->
<div class="control-pad" id="controls">
  <div class="control-row">
    <div class="ctl-btn" id="btnLeft">◄</div>
    <div class="ctl-btn" id="btnForward">▲</div>
    <div class="ctl-btn" id="btnRight">►</div>
  </div>
  <div class="control-row">
    <div class="ctl-btn brake" id="btnBrake">Brake</div>
    <div class="ctl-btn" id="btnBoost">Boost</div>
    <div class="ctl-btn" id="btnShop">Shop</div>
  </div>
  <div style="margin-top:8px; text-align:center">
    <button id="btnMap" class="btn" style="width:120px">Full Map</button>
  </div>
</div>

<div id="footerHints">
  Use arrows or WASD to move, space to brake. Tap screen buttons on mobile.
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.161.1/build/three.min.js"></script>
<script>
// ================== Persistent User Handling ==================
let currentUser = null;
function saveUser() {
  if(currentUser) localStorage.setItem('carGameUser', JSON.stringify(currentUser));
}
function loadUser() {
  const data = localStorage.getItem('carGameUser');
  if(data) currentUser = JSON.parse(data);
}
loadUser();
if(currentUser) {
  document.getElementById('userName').innerText = currentUser.name;
  document.getElementById('coinsLabel').innerText = currentUser.coins||0;
} else {
  document.getElementById('loginModal').style.display = 'block';
}
document.getElementById('loginBtn').onclick = () => {
  const name = document.getElementById('loginName').value.trim();
  const mobile = document.getElementById('loginMobile').value.trim();
  if(!name||!mobile){alert('Please fill both fields'); return;}
  currentUser = {name:name,mobile:mobile,coins:0,selectedCar:'default'};
  saveUser();
  document.getElementById('userName').innerText = name;
  document.getElementById('coinsLabel').innerText = '0';
  document.getElementById('loginModal').style.display = 'none';
};

// ================== Three.js Setup ==================
const container = document.getElementById('gameContainer');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x062122);
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight,0.1,2000);
camera.position.set(0,6,-14);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
container.appendChild(renderer.domElement);

// Minimap
const mmRenderer = new THREE.WebGLRenderer({antialias:true, canvas:document.getElementById('minimap')});
mmRenderer.setSize(260,160);
const mmCamera = new THREE.OrthographicCamera(-20,20,20,-20,0.1,2000);
mmCamera.position.set(0,100,0);
mmCamera.lookAt(0,0,0);

// Light
const light = new THREE.DirectionalLight(0xffffff,1.0);
light.position.set(100,200,100);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040,0.8));

// ================== Ground ==================
const groundGeo = new THREE.PlaneGeometry(2000,2000);
const groundMat = new THREE.MeshStandardMaterial({color:0x0b2c3d});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ================== Player Car ==================
const playerGeo = new THREE.BoxGeometry(1.6,0.6,3);
const playerMat = new THREE.MeshStandardMaterial({color:0xff5500});
const playerMesh = new THREE.Mesh(playerGeo,playerMat);
playerMesh.position.y = 0.3;
scene.add(playerMesh);
const player = {
  mesh:playerMesh,
  velocity:0,
  angle:0
};

// ================== Track & Coins ==================
let currentLevel = 1;
const totalLevels = 1000;
document.getElementById('totalLevels').innerText = totalLevels;
document.getElementById('levelLabel').innerText = currentLevel;

const coins = [];
function generateLevel(level){
  // Clear old coins
  coins.forEach(c=>scene.remove(c));
  coins.length=0;
  for(let i=0;i<level+4;i++){
    const coinGeo = new THREE.CylinderGeometry(0.4,0.4,0.1,16);
    const coinMat = new THREE.MeshStandardMaterial({color:0xffd700});
    const coin = new THREE.Mesh(coinGeo,coinMat);
    coin.rotation.x = Math.PI/2;
    coin.position.set(Math.random()*40-20,0.2, -i*10);
    scene.add(coin);
    coins.push(coin);
  }
}
generateLevel(currentLevel);

// ================== Input ==================
const keys={left:false,right:false,forward:false,brake:false};
document.addEventListener('keydown', e=>{
  if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=true;
  if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=true;
  if(e.code==='ArrowUp'||e.code==='KeyW') keys.forward=true;
  if(e.code==='Space') keys.brake=true;
});
document.addEventListener('keyup', e=>{
  if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=false;
  if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=false;
  if(e.code==='ArrowUp'||e.code==='KeyW') keys.forward=false;
  if(e.code==='Space') keys.brake=false;
});

// Mobile buttons
document.getElementById('btnLeft').addEventListener('pointerdown',()=>keys.left=true);
document.getElementById('btnLeft').addEventListener('pointerup',()=>keys.left=false);
document.getElementById('btnRight').addEventListener('pointerdown',()=>keys.right=true);
document.getElementById('btnRight').addEventListener('pointerup',()=>keys.right=false);
document.getElementById('btnForward').addEventListener('pointerdown',()=>keys.forward=true);
document.getElementById('btnForward').addEventListener('pointerup',()=>keys.forward=false);
document.getElementById('btnBrake').addEventListener('pointerdown',()=>keys.brake=true);
document.getElementById('btnBrake').addEventListener('pointerup',()=>keys.brake=false);

// ================== Game Loop ==================
let lastTime = performance.now();
let levelStart = performance.now();
function animate(){
  requestAnimationFrame(animate);
  const now = performance.now();
  const dt = (now-lastTime)/1000;
  lastTime=now;

  // Movement
  if(keys.forward) player.velocity+=dt*15;
  else player.velocity*=0.98;
  if(keys.brake) player.velocity*=0.92;
  if(keys.left) player.angle+=dt*2;
  if(keys.right) player.angle-=dt*2;

  player.mesh.rotation.y = player.angle;
  player.mesh.position.x += Math.sin(player.angle)*player.velocity*dt;
  player.mesh.position.z += Math.cos(player.angle)*player.velocity*dt;

  // Coin collision
  coins.forEach((c,i)=>{
    if(c.position.distanceTo(player.mesh.position)<1){
      scene.remove(c);
      coins.splice(i,1);
      currentUser.coins = (currentUser.coins||0)+1;
      document.getElementById('coinsLabel').innerText=currentUser.coins;
      saveUser();
    }
  });

  // Level complete
  if(coins.length===0){
    document.getElementById('completeLevel').innerText=currentLevel;
    document.getElementById('completeCoins').innerText=currentUser.coins;
    document.getElementById('levelCompleteOverlay').style.display='block';
  }

  // Camera follow
  const offset = new THREE.Vector3(0,6,-14);
  const sin=Math.sin(player.angle);
  const cos=Math.cos(player.angle);
  camera.position.set(
    player.mesh.position.x + sin*-offset.z,
    player.mesh.position.y+offset.y,
    player.mesh.position.z + cos*-offset.z
  );
  camera.lookAt(player.mesh.position.x, player.mesh.position.y+1.5, player.mesh.position.z);

  // Minimap
  mmCamera.position.set(player.mesh.position.x,80,player.mesh.position.z);
  mmCamera.lookAt(player.mesh.position.x,0,player.mesh.position.z);

  renderer.render(scene,camera);
  mmRenderer.render(scene,mmCamera);

  // HUD time
  document.getElementById("timeLabel").innerText=((now-levelStart)/1000).toFixed(2);
}
animate();

window.addEventListener("resize", ()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});

// ================== Level Complete Actions ==================
document.getElementById('nextLevelBtn').onclick=()=>{
  currentLevel=Math.min(currentLevel+1,totalLevels);
  document.getElementById('levelLabel').innerText=currentLevel;
  generateLevel(currentLevel);
  levelStart = performance.now();
  document.getElementById('levelCompleteOverlay').style.display='none';
};
document.getElementById('skipTo3Btn').onclick=()=>{
  currentLevel=3;
  document.getElementById('levelLabel').innerText=currentLevel;
  generateLevel(currentLevel);
  levelStart = performance.now();
  document.getElementById('levelCompleteOverlay').style.display='none';
};
document.getElementById('closeOverlayBtn').onclick=()=>{
  document.getElementById('levelCompleteOverlay').style.display='none';
};

// ================== Shop ==================
document.getElementById('btnShop').onclick=()=>{document.getElementById('shopOverlay').style.display='block';};
document.getElementById('closeShop').onclick=()=>{document.getElementById('shopOverlay').style.display='none';};
document.getElementById('shopCoins').innerText = currentUser.coins||0;
document.getElementById('shopSelected').innerText = currentUser.selectedCar||'Default';

const carTypes = [
  {name:'Red Racer',price:0,color:0xff5500},
  {name:'Blue Bolt',price:10,color:0x0055ff},
  {name:'Green Speeder',price:20,color:0x00ff55}
];
const carsList = document.getElementById('carsList');
carTypes.forEach((c,i)=>{
  const div=document.createElement('div'); div.className='car-card';
  div.innerHTML=`<div style="width:50px;height:30px;background:#${c.color.toString(16).padStart(6,'0')}; border-radius:4px;"></div>
    <div style="flex:1">${c.name} <br>Price: ${c.price}</div>
  `;
  div.onclick=()=>{selectedCar=i; document.getElementById('shopSelected').innerText=c.name;};
  carsList.appendChild(div);
});
let selectedCar=0;
document.getElementById('buyBtn').onclick=()=>{
  const c = carTypes[selectedCar];
  if(c.price<=currentUser.coins){
    currentUser.coins -= c.price;
    currentUser.selectedCar=c.name;
    document.getElementById('coinsLabel').innerText=currentUser.coins;
    document.getElementById('shopCoins').innerText=currentUser.coins;
    document.getElementById('shopSelected').innerText=c.name;
    player.mesh.material.color.setHex(c.color);
    saveUser();
  } else {alert('Not enough coins');}
};

// ================== Full Map ==================
document.getElementById('btnMap').onclick=()=>{document.getElementById('fullMapOverlay').style.display='flex';};
document.getElementById('fullMapOverlay').onclick=()=>{document.getElementById('fullMapOverlay').style.display='none';};
</script>
</body>
</html>
